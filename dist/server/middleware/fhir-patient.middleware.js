"use strict";function asyncGeneratorStep(a,b,c,d,e,f,g){try{var h=a[f](g),i=h.value}catch(a){return void c(a)}h.done?b(i):Promise.resolve(i).then(d,e)}function _asyncToGenerator(a){return function(){var b=this,c=arguments;return new Promise(function(d,e){function f(a){asyncGeneratorStep(h,d,e,f,g,"next",a)}function g(a){asyncGeneratorStep(h,d,e,f,g,"throw",a)}var h=a.apply(b,c);f(void 0)})}}var request=require("request-promise");/**
 * @author Frazer Smith
 * @param {Object} config - FHIR API endpoint access config values.
 * @return {Function} express middleware
 * @description Queries FHIR API endpoints for Patient Resource using MRN or NHS No. provided.
 */module.exports=function(a){return(/*#__PURE__*/function(){var b=_asyncToGenerator(/*#__PURE__*/regeneratorRuntime.mark(function b(c,d,e){var f;return regeneratorRuntime.wrap(function(b){for(;;)switch(b.prev=b.next){case 0:return f="",""!==c.query.nhsno&&"undefined"!=typeof c.query.nhsno?f="".concat(a.url,"Patient?identifier=https://fhir.nhs.uk/Id/nhs-number|").concat(c.query.nhsno):""!==c.query.mrn&&"undefined"!=typeof c.query.mrn?f="".concat(a.url,"Patient?identifier=https://fhir.ydh.nhs.uk/Id/local-patient-identifier|").concat(c.query.mrn):d.redirect(400,"back"),b.next=4,request.get(f,a.options).then(function(a){var b={},d=a.entry[0].resource;b.patient_gender=d.gender,b.patient_dobIso=d.birthDate;// Inefficient way of getting it into DD/MM/YYYY because staff can't read ISO format,
// and localestring pushes it into American
var f=new Date(d.birthDate);if(b.patient_dob=[f.getDate(),10>f.getMonth()+1?"0".concat(f.getMonth()+1):f.getMonth()+1,f.getFullYear()].join("/"),d.name)for(var g,h=0;h<d.name.length;h+=1)if(g=d.name[h],"usual"===g.use.toString().toLowerCase()){b.patient_surname=g.family,b.patient_forename=g.given[0];break}if(d.identifier)for(var i,j=0;j<d.identifier.length;j+=1)i=d.identifier[j],"official"===i.use.toString().toLowerCase()&&"https://fhir.nhs.uk/Id/nhs-number"===i.system.toString()&&(b.patient_nhsNo=i.value),"usual"===i.use.toString().toLowerCase()&&"https://fhir.ydh.nhs.uk/Id/local-patient-identifier"===i.system.toString()&&(b.patient_mrn=i.value);if("undefined"==typeof b.patient_nhsNo&&(b.patient_nhsNo=""),d.address)for(var k,l=0;l<d.address.length;l+=1)if(k=d.address[l],"home"===k.use.toString().toLowerCase()){b.patient_addressCity=k.city,b.patient_addressPostalCode=k.postalCode,b.patient_addressDistrict=k.district,b.patient_address=k.line;break}if(d.contained)for(var m,n=0;n<d.contained.length;n+=1)if(m=d.contained[n],"organization"===m.resourceType.toString().toLowerCase()&&m.id.toString()===d.generalPractitioner[0].reference.replace("#","")){b.gp_id=m.id,b.gp_name=m.name,b.gp_address="".concat(m.address[0].line.toString(),", ").concat(m.address[0].city,", ").concat(m.address[0].postalCode);break}c.patientresource=b,e()})["catch"](function(){d.redirect(400,"back")});case 4:case"end":return b.stop();}},b)}));return function(){return b.apply(this,arguments)}}())};