"use strict";function asyncGeneratorStep(a,b,c,d,e,f,g){try{var h=a[f](g),i=h.value}catch(a){return void c(a)}h.done?b(i):Promise.resolve(i).then(d,e)}function _asyncToGenerator(a){return function(){var b=this,c=arguments;return new Promise(function(d,e){function f(a){asyncGeneratorStep(h,d,e,f,g,"next",a)}function g(a){asyncGeneratorStep(h,d,e,f,g,"throw",a)}var h=a.apply(b,c);f(void 0)})}}var request=require("request-promise");/**
 * @author Frazer Smith
 * @param {Object} config - FHIR API endpoint access config values.
 * @return {Function} express middleware
 * @description Queries FHIR API endpoints for Patient Resource using MRN or NHS No. provided.
 */module.exports=function(a){return(/*#__PURE__*/function(){var b=_asyncToGenerator(/*#__PURE__*/regeneratorRuntime.mark(function b(c,d,e){var f;return regeneratorRuntime.wrap(function(b){for(;;)switch(b.prev=b.next){case 0:return f="",""!==c.patient_nhsNo&&"undefined"!=typeof c.patient_nhsNo?f="".concat(a.url,"Encounter?identifier=https://fhir.nhs.uk/Id/nhs-number|").concat(c.patient_nhsNo,"&class=inpatient"):""!==c.customparams.patient_mrn&&"undefined"!=typeof c.customparams.patient_mrn&&(f="".concat(a.url,"Encounter?identifier=https://fhir.ydh.nhs.uk/Id/local-patient-identifier|").concat(c.customparams.patient_mrn,"&class=inpatient")),b.next=4,request.get(f,a.options).then(function(a){var b=[],d=a.entry;d.forEach(function(a){var c={};// Only parse inpatient encounter resources
"IMP"===a.resource["class"].code&&(a.resource.type.forEach(function(a){a.coding.forEach(function(a){"https://fhir.nhs.uk/STU3/CodeSystem/DCH-Specialty-1"===a.system&&(c.admission_specialty=a.display)})}),c.admission_date=a.resource.period.start,c.discharge_date=a.resource.period.end,a.resource.hospitalization.extension.forEach(function(a){"https://fhir.hl7.org.uk/STU3/StructureDefinition/Extension-CareConnect-AdmissionMethod-1"===a.url&&(c.admission_method=a.valueCodeableConcept.coding[0].display),"https://fhir.hl7.org.uk/STU3/StructureDefinition/Extension-CareConnect-DischargeMethod-1"===a.url&&(c.discharge_method=a.valueCodeableConcept.coding[0].display)}),a.resource.participant.forEach(function(a){a.type.forEach(function(b){b.coding.forEach(function(b){"ADM"===b.code&&(c.admission_careProvider=a.individual.display),"DIS"===b.code&&(c.discharge_careProvider=a.individual.display)})})}),c.admission_source=a.resource.hospitalization.admitSource.coding[0].display,b.push(c))}),c.encounterresources=b,e()})["catch"](function(a){e(a)});case 4:case"end":return b.stop();}},b)}));return function(){return b.apply(this,arguments)}}())};