"use strict";function _typeof(a){return _typeof="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(a){return typeof a}:function(a){return a&&"function"==typeof Symbol&&a.constructor===Symbol&&a!==Symbol.prototype?"symbol":typeof a},_typeof(a)}function asyncGeneratorStep(a,b,c,d,e,f,g){try{var h=a[f](g),i=h.value}catch(a){return void c(a)}h.done?b(i):Promise.resolve(i).then(d,e)}function _asyncToGenerator(a){return function(){var b=this,c=arguments;return new Promise(function(d,e){function f(a){asyncGeneratorStep(h,d,e,f,g,"next",a)}function g(a){asyncGeneratorStep(h,d,e,f,g,"throw",a)}var h=a.apply(b,c);f(void 0)})}}/* eslint-disable max-len */ /**
 * @author Frazer Smith
 * @param {Object} pool - Pool object.
 * @return {Function} express middleware
 * @description Transforms and upserts discharge summary to PostgreSQL DB.
 * @todo Convert queries within to parameterised ones to prevent SQL injections.
 * @todo Attempt to make this code dynamic.
 */module.exports=function(a){return(/*#__PURE__*/function(){var b=_asyncToGenerator(/*#__PURE__*/regeneratorRuntime.mark(function b(c,d,e){var f,g,h,l,m,n,o,p,q,r,s,t;return regeneratorRuntime.wrap(function(b){for(;;)switch(b.prev=b.next){case 0:// Push follow-up appointments, medication changes, and ttos into objects rather
// than keep in array/strings, far more structured and safer
if("undefined"!=typeof c.customparams.followup_with){if(c.customparams.followups=[],"object"===_typeof(c.customparams.followup_with))for(f=0;f<c.customparams.followup_with.length;f+=1)g={followup_details:c.customparams.followup_details[f],followup_interval:c.customparams.followup_interval[f],followup_intervalNumber:c.customparams.followup_intervalNumber[f],followup_notes:c.customparams.followup_notes[f],followup_with:c.customparams.followup_with[f]},c.customparams.followups.push(g);else h={followup_details:c.customparams.followup_details,followup_interval:c.customparams.followup_interval,followup_intervalNumber:c.customparams.followup_intervalNumber,followup_notes:c.customparams.followup_notes,followup_with:c.customparams.followup_with},c.customparams.followups.push(h);delete c.customparams.followup_details,delete c.customparams.followup_interval,delete c.customparams.followup_intervalNumber,delete c.customparams.followup_notes,delete c.customparams.followup_with}if("undefined"!=typeof c.customparams.medication_changedMed){if(c.customparams.changedmeds=[],"object"===_typeof(c.customparams.medication_changedMed))for(l=0;l<c.customparams.medication_changedMed.length;l+=1)m={medication_changedMed:c.customparams.medication_changedMed[l],medication_changedPlan:c.customparams.medication_changedPlan[l],medication_changedReason:c.customparams.medication_changedReason[l]},c.customparams.changedmeds.push(m);else n={medication_changedMed:c.customparams.medication_changedMed,medication_changedPlan:c.customparams.medication_changedPlan,medication_changedReason:c.customparams.medication_changedReason},c.customparams.changedmeds.push(n);delete c.customparams.medication_changedMed,delete c.customparams.medication_changedPlan,delete c.customparams.medication_changedReason}if("undefined"!=typeof c.customparams.medication_ttoMedication){if(c.customparams.ttos=[],"object"===_typeof(c.customparams.medication_ttoMedication))for(o=0;o<c.customparams.medication_ttoMedication.length;o+=1)p={medication_finalPharmacySignOffCheck:c.customparams.medication_finalPharmacySignOffCheck[o],medication_finalPharmacySignOffDate:c.customparams.medication_finalPharmacySignOffDate[o],medication_finalPharmacySignOffName:c.customparams.medication_finalPharmacySignOffName[o],medication_finalPharmacySignOffTime:c.customparams.medication_finalPharmacySignOffTime[o],medication_ttoComments:c.customparams.medication_ttoComments[o],medication_ttoDose:c.customparams.medication_ttoDose[o],medication_ttoFrequency:c.customparams.medication_ttoFrequency[o],medication_ttoLengthOfCourse:c.customparams.medication_ttoLengthOfCourse[o],medication_ttoLockDate:c.customparams.medication_ttoLockDate[o],medication_ttoLockUser:c.customparams.medication_ttoLockUser[o],medication_ttoMedication:c.customparams.medication_ttoMedication[o],medication_ttoPharmacyAvailability:c.customparams.medication_ttoPharmacyAvailability[o],medication_ttoPharmacySignOffCheck:c.customparams.medication_ttoPharmacySignOffCheck[o],medication_ttoPharmacySignOffDate:c.customparams.medication_ttoPharmacySignOffDate[o],medication_ttoPharmacySignOffName:c.customparams.medication_ttoPharmacySignOffName[o],medication_ttoPharmacySignOffTime:c.customparams.medication_ttoPharmacySignOffTime[o],medication_ttoRoute:c.customparams.medication_ttoRoute[o],medication_ttoStartDate:c.customparams.medication_ttoStartDate[o],medication_ttoUnit:c.customparams.medication_ttoUnit[o]},c.customparams.ttos.push(p);else q={medication_finalPharmacySignOffCheck:c.customparams.medication_finalPharmacySignOffCheck,medication_finalPharmacySignOffDate:c.customparams.medication_finalPharmacySignOffDate,medication_finalPharmacySignOffName:c.customparams.medication_finalPharmacySignOffName,medication_finalPharmacySignOffTime:c.customparams.medication_finalPharmacySignOffTime,medication_ttoComments:c.customparams.medication_ttoComments,medication_ttoDose:c.customparams.medication_ttoDose,medication_ttoFrequency:c.customparams.medication_ttoFrequency,medication_ttoLengthOfCourse:c.customparams.medication_ttoLengthOfCourse,medication_ttoLockDate:c.customparams.medication_ttoLockDate,medication_ttoLockUser:c.customparams.medication_ttoLockUser,medication_ttoMedication:c.customparams.medication_ttoMedication,medication_ttoPharmacyAvailability:c.customparams.medication_ttoPharmacyAvailability,medication_ttoPharmacySignOffCheck:c.customparams.medication_ttoPharmacySignOffCheck,medication_ttoPharmacySignOffDate:c.customparams.medication_ttoPharmacySignOffDate,medication_ttoPharmacySignOffName:c.customparams.medication_ttoPharmacySignOffName,medication_ttoPharmacySignOffTime:c.customparams.medication_ttoPharmacySignOffTime,medication_ttoRoute:c.customparams.medication_ttoRoute,medication_ttoUnit:c.customparams.medication_ttoUnit},c.customparams.ttos.push(q);delete c.customparams.medication_finalPharmacySignOffCheck,delete c.customparams.medication_finalPharmacySignOffDate,delete c.customparams.medication_finalPharmacySignOffName,delete c.customparams.medication_finalPharmacySignOffTime,delete c.customparams.medication_ttoComments,delete c.customparams.medication_ttoDose,delete c.customparams.medication_ttoFrequency,delete c.customparams.medication_ttoLengthOfCourse,delete c.customparams.medication_ttoLockDate,delete c.customparams.medication_ttoLockUser,delete c.customparams.medication_ttoMedication,delete c.customparams.medication_ttoPharmacyAvailability,delete c.customparams.medication_ttoPharmacySignOffCheck,delete c.customparams.medication_ttoPharmacySignOffDate,delete c.customparams.medication_ttoPharmacySignOffName,delete c.customparams.medication_ttoPharmacySignOffTime,delete c.customparams.medication_ttoRoute,delete c.customparams.medication_ttoUnit}// Stop id and version being inserted into raw body
r=c.customparams.row_id,s=+c.customparams.version,delete c.customparams.row_id,delete c.customparams.version,c.customparams.lastUpdatedBy=d.locals.user,b.t0=c.customparams.action,b.next="Create New Form and Continue"===b.t0?11:"Create New Form and Exit"===b.t0?11:"Create New Form and Submit discharge summary"===b.t0?11:"Save and Continue"===b.t0?14:"Save and Exit"===b.t0?14:"Save and Submit discharge summary"===b.t0?14:"Save and Preview"===b.t0?14:11;break;case 11:return delete c.customparams.action,t="INSERT INTO public.discharge_summary(\"lastUpdate\", \"raw\", version)\n\t\tVALUES(CURRENT_TIMESTAMP, '".concat(JSON.stringify(c.customparams),"', 1)\n\t\tRETURNING id, \"lastUpdate\", \"raw\", version;"),b.abrupt("break",17);case 14:return delete c.customparams.action,t="INSERT INTO public.discharge_summary(id, \"lastUpdate\", \"raw\", version)\n\t\tVALUES('".concat(r,"', CURRENT_TIMESTAMP, '").concat(JSON.stringify(c.customparams),"', ").concat(s+=1,")\n\t\tON CONFLICT (id, version) DO UPDATE SET id ='").concat(r,"', version = ").concat(s,"\n\t\tRETURNING id, \"lastUpdate\", \"raw\", version;"),b.abrupt("break",17);case 17:return b.next=19,a.query(t).then(function(a){c.customparams.query={command:a.command},c.customparams.row_id=a.rows[0].id;var b=new Date(a.rows[0].lastUpdate),d=[b.getDate(),10>b.getMonth()+1?"0".concat(b.getMonth()+1):b.getMonth()+1,b.getFullYear()].join("/");c.customparams.lastUpdate="".concat(d," ").concat(new Date(a.rows[0].lastUpdate).toLocaleTimeString()),c.customparams.version=a.rows[0].version,1===a.rowCount?(c.customparams.query.result="success",e()):(c.customparams.query.result="warning",e())})["catch"](function(a){e(a)});case 19:case"end":return b.stop();}},b)}));return function(){return b.apply(this,arguments)}}())};