"use strict";function asyncGeneratorStep(a,b,c,d,e,f,g){try{var h=a[f](g),i=h.value}catch(a){return void c(a)}h.done?b(i):Promise.resolve(i).then(d,e)}function _asyncToGenerator(a){return function(){var b=this,c=arguments;return new Promise(function(d,e){function f(a){asyncGeneratorStep(h,d,e,f,g,"next",a)}function g(a){asyncGeneratorStep(h,d,e,f,g,"throw",a)}var h=a.apply(b,c);f(void 0)})}}function _typeof(a){return _typeof="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(a){return typeof a}:function(a){return a&&"function"==typeof Symbol&&a.constructor===Symbol&&a!==Symbol.prototype?"symbol":typeof a},_typeof(a)}/* eslint-disable sort-keys */var _require=require("pg"),Pool=_require.Pool,postgresqlUpsertMiddleware=require("./postgresql-upsert.middleware"),_require2=require("../../test.config"),postgresqlConfig=_require2.postgresqlConfig;require("regenerator-runtime"),describe("PostgreSQL DB upsert middleware",function(){test("Should return a middleware function",function(){var a=postgresqlUpsertMiddleware();expect(_typeof(a)).toBe("function")}),test("Should insert a new discharge summary record into DB",/*#__PURE__*/_asyncToGenerator(/*#__PURE__*/regeneratorRuntime.mark(function a(){var b,c,d,e;return regeneratorRuntime.wrap(function(a){for(;;)switch(a.prev=a.next){case 0:return b=postgresqlUpsertMiddleware(new Pool(postgresqlConfig)),c={customparams:{action:"Create New Form and Exit",patient_nhsNo:"",patient_mrn:"5484125",patient_surname:"Zzztest",patient_forename:"Charlotte",patient_dob:"1/09/1989",patient_gender:"female",patient_addressLine1:"NHS Foundation Trust",patient_addressLine2:"Yeovil District Hospital",patient_addressCity:"Yeovil",patient_addressDistrict:"Somerset",patient_addressPostalCode:"BA21 4AT",patient_addressAccommodationType:"",gp_id:"V81999",gp_name:"0 GMP Unknown",gp_address:"Unknown GP, undefined, undefined",patient_individualRequirements:"",admission_specialty:"",admission_date:"2019-09-26",admission_time:"",admission_method:"",admission_careProvider:"",admission_ward:"",admission_source:"",discharge_specialty:"",discharge_date:"",discharge_time:"",discharge_estimatedDate:"",discharge_method:"PATIENT discharged on clinical advice or with clinical consent",discharge_careProvider:"",discharge_ward:"",discharge_destination:"",discharge_differentAddressLine1:"",discharge_differentAddressLine2:"",discharge_differentAddressCity:"",discharge_differentAddressDistrict:"",discharge_differentAddressPostalCode:"",discharge_differentAddressContactNo:"",discharge_differentAddressComments:"",clinical_admissionReason:"",clinical_initialPresentation:"",clinical_preexistingConditions:"",clinical_significantInvestigations:"",clinical_conditionManagement:"",clinical_outstandingResults:"",clinical_patientConcerns:"",clinical_significantEvents:"",clinical_adverseIncidents:"",clinical_aki:"",clinical_akiPresent:"",clinical_akiHospital:"",clinical_akiStage:"",clinical_akiMedReview:"No",clinical_dnar:"",clinical_epaccs:"",clinical_advancedCarePlan:"",followup_akiText:"",followup_akiStatus:"",signoff_nurseFirstName:"",signoff_nurseFirstDate:"",signoff_nurseFirstTime:"",signoff_nurseSecondName:"",signoff_nurseSecondDate:"",signoff_nurseSecondTime:"",signoff_drName:"",signoff_drDate:"",signoff_drTime:"",signoff_drContactNo:"",signoff_drGrade:"",patient_address:["NHS Foundation Trust","Yeovil District Hospital"]}},d={locals:{user:"frazer.smith"}},e=jest.fn(),a.next=6,b(c,d,e);case 6:expect(c.customparams.query.result).toBe("success"),expect(e).toHaveBeenCalledTimes(1);case 8:case"end":return a.stop();}},a)}))),test("Should convert follow-up and medication arrays into arrays of objects before inserting",/*#__PURE__*/_asyncToGenerator(/*#__PURE__*/regeneratorRuntime.mark(function a(){var b,c,d,e;return regeneratorRuntime.wrap(function(a){for(;;)switch(a.prev=a.next){case 0:return b=postgresqlUpsertMiddleware(new Pool(postgresqlConfig)),c={customparams:{action:"Create New Form and Exit",patient_nhsNo:"",patient_mrn:"5484125",patient_surname:"Zzztest",patient_forename:"Charlotte",patient_dob:"1/09/1989",patient_gender:"female",patient_addressLine1:"NHS Foundation Trust",patient_addressLine2:"Yeovil District Hospital",patient_addressCity:"Yeovil",patient_addressDistrict:"Somerset",patient_addressPostalCode:"BA21 4AT",patient_addressAccommodationType:"",gp_id:"V81999",gp_name:"0 GMP Unknown",gp_address:"Unknown GP, undefined, undefined",patient_individualRequirements:"",admission_specialty:"",admission_date:"2019-09-26",admission_time:"",admission_method:"",admission_careProvider:"",admission_ward:"",admission_source:"",discharge_specialty:"",discharge_date:"",discharge_time:"",discharge_estimatedDate:"",discharge_method:"PATIENT discharged on clinical advice or with clinical consent",discharge_careProvider:"",discharge_ward:"",discharge_destination:"",discharge_differentAddressLine1:"",discharge_differentAddressLine2:"",discharge_differentAddressCity:"",discharge_differentAddressDistrict:"",discharge_differentAddressPostalCode:"",discharge_differentAddressContactNo:"",discharge_differentAddressComments:"",clinical_admissionReason:"",clinical_initialPresentation:"",clinical_preexistingConditions:"",clinical_significantInvestigations:"",clinical_conditionManagement:"",clinical_outstandingResults:"",clinical_patientConcerns:"",clinical_significantEvents:"",clinical_adverseIncidents:"",clinical_aki:"",clinical_akiPresent:"",clinical_akiHospital:"",clinical_akiStage:"",clinical_akiMedReview:"No",clinical_dnar:"",clinical_epaccs:"",clinical_advancedCarePlan:"",medication_allergiesFreetext:"",medication_change:"Yes",medication_changedMed:["Medication change test 2","Medication change test 1"],medication_changedReason:["2","1"],medication_changedPlan:["Continue as prescribed","Complete the prescribed course"],medication_tto:"Yes",medication_ttoLockDate:["",""],medication_ttoLockUser:["",""],medication_ttoMedication:["Test medication 2","Test medication 1"],medication_ttoDose:["2","1"],medication_ttoUnit:["applicatorful","application"],medication_ttoRoute:["","BUC - Buccal"],medication_ttoStartDate:["",""],medication_ttoFrequency:["2","1"],medication_ttoLengthOfCourse:["weeks","day"],medication_ttoComments:["",""],medication_ttoPharmacySignOffName:["","frazer.smith"],medication_ttoPharmacySignOffDate:["","2019-10-02"],medication_ttoPharmacySignOffTime:["","09: 19: 11"],medication_ttoPharmacyAvailability:["","CD Prescription"],medication_finalPharmacySignOffName:["","frazer.smith"],medication_finalPharmacySignOffDate:["","2019-10-02"],medication_finalPharmacySignOffTime:["","09: 19: 12"],medication_ttoPharmacySignOffCheck:"on",medication_finalPharmacySignOffCheck:"on",followup_akiText:"",followup_akiStatus:"",followup_with:"AEC",followup_intervalNumber:"1",followup_interval:"Day(s)",followup_details:"",followup_notes:"",signoff_nurseFirstName:"",signoff_nurseFirstDate:"",signoff_nurseFirstTime:"",signoff_nurseSecondName:"",signoff_nurseSecondDate:"",signoff_nurseSecondTime:"",signoff_drName:"",signoff_drDate:"",signoff_drTime:"",signoff_drContactNo:"",signoff_drGrade:"",patient_address:["NHS Foundation Trust","Yeovil District Hospital"]}},d={locals:{user:"frazer.smith"}},e=jest.fn(),a.next=6,b(c,d,e);case 6:expect(c.customparams.query.result).toBe("success"),expect(c.customparams.medication_ttoComments).toBeUndefined(),expect(e).toHaveBeenCalledTimes(1);case 9:case"end":return a.stop();}},a)}))),test("Should update an existing discharge summary record in the DB",/*#__PURE__*/_asyncToGenerator(/*#__PURE__*/regeneratorRuntime.mark(function a(){var b,c,d,e;return regeneratorRuntime.wrap(function(a){for(;;)switch(a.prev=a.next){case 0:return b=postgresqlUpsertMiddleware(new Pool(postgresqlConfig)),c={customparams:{version:420,action:"Save and Exit",patient_nhsNo:"",patient_mrn:"5484125",patient_surname:"Zzztest",patient_forename:"Charlotte",patient_dob:"1/09/1989",patient_gender:"female",patient_addressLine1:"NHS Foundation Trust",patient_addressLine2:"Yeovil District Hospital",patient_addressCity:"Yeovil",patient_addressDistrict:"Somerset",patient_addressPostalCode:"BA21 4AT",patient_addressAccommodationType:"",gp_id:"V81999",gp_name:"0 GMP Unknown",gp_address:"Unknown GP, undefined, undefined",patient_individualRequirements:"",admission_specialty:"",admission_date:"2019-09-26",admission_time:"",admission_method:"",admission_careProvider:"",admission_ward:"",admission_source:"",discharge_specialty:"",discharge_date:"",discharge_time:"",discharge_estimatedDate:"",discharge_method:"PATIENT discharged on clinical advice or with clinical consent",discharge_careProvider:"",discharge_ward:"",discharge_destination:"",discharge_differentAddressLine1:"",discharge_differentAddressLine2:"",discharge_differentAddressCity:"",discharge_differentAddressDistrict:"",discharge_differentAddressPostalCode:"",discharge_differentAddressContactNo:"",discharge_differentAddressComments:"",clinical_admissionReason:"",clinical_initialPresentation:"",clinical_preexistingConditions:"",clinical_significantInvestigations:"",clinical_conditionManagement:"",clinical_outstandingResults:"",clinical_patientConcerns:"",clinical_significantEvents:"",clinical_adverseIncidents:"",clinical_aki:"",clinical_akiPresent:"",clinical_akiHospital:"",clinical_akiStage:"",clinical_akiMedReview:"No",clinical_dnar:"",clinical_epaccs:"",clinical_advancedCarePlan:"",followup_akiText:"",followup_akiStatus:"",signoff_nurseFirstName:"",signoff_nurseFirstDate:"",signoff_nurseFirstTime:"",signoff_nurseSecondName:"",signoff_nurseSecondDate:"",signoff_nurseSecondTime:"",signoff_drName:"",signoff_drDate:"",signoff_drTime:"",signoff_drContactNo:"",signoff_drGrade:"",patient_address:["NHS Foundation Trust","Yeovil District Hospital"]}},d={locals:{user:"frazer.smith"}},e=jest.fn(),a.next=6,b(c,d,e);case 6:expect(c.customparams.query.result).toBe("success"),expect(e).toHaveBeenCalledTimes(1);case 8:case"end":return a.stop();}},a)}))),test("Should fail if config missing",/*#__PURE__*/_asyncToGenerator(/*#__PURE__*/regeneratorRuntime.mark(function a(){var b,c,d,e;return regeneratorRuntime.wrap(function(a){for(;;)switch(a.prev=a.next){case 0:return b=postgresqlUpsertMiddleware(new Pool),c={customparams:{patient_mrn:"5484125"}},d={locals:{user:"frazer.smith"}},e=jest.fn(),a.next=6,b(c,d,e);case 6:expect(e.mock.calls[0][0].message.substring(0,30)).toMatch(/^password authentication failed|read ECONNRESET/i),expect(e).toHaveBeenCalledTimes(1);case 8:case"end":return a.stop();}},a)})))});